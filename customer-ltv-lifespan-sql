*/--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. Revenue Per Customer
   - Calculates total revenue generated by each customer.
*/--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SELECT 
    customer_id,
    SUM(amount) AS total_revenue
FROM 
    customer.transactions
GROUP BY 
    customer_id;
/*--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 2. Customer Lifespan in Months
   - Calculates how long (in months) a customer was active using signup and cancel dates.
   - If cancel_date is NULL, assume the customer is still active (use CURDATE()).
*/--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SELECT 
    customer_id,
    TIMESTAMPDIFF(
        MONTH, 
        signup_date, 
        IFNULL(cancel_date, CURDATE())
    ) AS lifespan_months
FROM 
    customer.customers;
/* --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 3. Lifetime Value (LTV) Per Month
   - Combines revenue and lifespan to compute LTV per customer.
   - Formula: LTV = Total Revenue / Lifespan in months
   - Handles division by zero safely using NULLIF.
*/--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SELECT 
    c.customer_id,
    SUM(t.amount) AS total_revenue,
    TIMESTAMPDIFF(
        MONTH, 
        c.signup_date, 
        IFNULL(c.cancel_date, CURDATE())
    ) AS lifespan_months,

    ROUND(
        SUM(t.amount) / NULLIF(
            TIMESTAMPDIFF(MONTH, c.signup_date, IFNULL(c.cancel_date, CURDATE())), 
            0
        ), 
        2
    ) AS ltv_per_month

FROM 
    customer.customers c
LEFT JOIN 
    customer.transactions t 
    ON c.customer_id = t.customer_id

GROUP BY 
    c.customer_id, c.signup_date, c.cancel_date;
